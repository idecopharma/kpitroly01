<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BẢNG KPI - IDECO (Bản hoàn chỉnh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- QuillJS Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .table-container { overflow-x: auto; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; vertical-align: top; }
        th { background: #4f46e5; color: white; position: sticky; top: 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background:rgba(0,0,0,0.5);}
        .modal-content { background: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 90%; max-width: 600px;}
        .action-button { background: #4f46e5; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 500; border:none; cursor:pointer; }
        .action-button:hover { background: #4338ca; }
        .danger-button { background: #ef4444; }
        .danger-button:hover { background: #dc2626; }
        .secondary-button { background: #6b7280; }
        .secondary-button:hover { background: #4b5563; }
        .framed-info { border: 2px solid #6366f1; border-radius: 14px; background: #f5f3ff; box-shadow: 0 1px 8px #d1d5db33; }
        /* Quill resize */
        .quill-editor {
            min-height: 90px;
            resize: vertical;
            overflow: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            margin-bottom: 16px;
        }
        .ql-toolbar.ql-snow {
            border-radius: 8px 8px 0 0;
        }
        .ql-container.ql-snow {
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- FORM KPI -->
    <div class="container mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl" id="mainKpiForm" style="display: none;">
        <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">BẢNG KPI KINH DOANH - BÁO CÁO CÔNG VIỆC VÀ CHỈ SỐ KPI CUỐI KỲ THÁNG</h1>
        <div class="framed-info p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="creatorName" class="block text-sm font-medium text-gray-700 mb-1">Tên người lập:</label>
                <input type="text" id="creatorName" class="mt-1 block w-full rounded-md shadow-sm">
            </div>
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Bộ phận:</label>
                <input type="text" id="department" class="mt-1 block w-full rounded-md shadow-sm">
            </div>
            <div>
                <label for="creationDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày lập:</label>
                <input type="date" id="creationDate" class="mt-1 block w-full rounded-md shadow-sm">
            </div>
        </div>
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">KPI HOÀN THÀNH NHIỆM VỤ CHUYÊN MÔN (30% ĐIỂM) </h2>
        <div class="table-container mb-8 rounded-lg border border-gray-200">
            <table id="kpiTable" class="min-w-full">
                <thead>
                    <tr>
                        <th>Chỉ số KPI</th>
                        <th>Đạt chỉ số</th>
                        <th>Điểm KPI %</th>
                        <th>Đánh giá điểm</th>
                        <th>Báo cáo</th>
                        <th>Xóa</th>
                    </tr>
                </thead>
                <tbody id="kpiTableBody"></tbody>
            </table>
        </div>
        <button id="addRowBtn" class="action-button mb-8">Thêm hàng KPI</button>

        <!-- BẢNG 2 TĨNH -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-indigo-300 shadow-md">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">KPI DOANH THU MỤC TIÊU- TĂNG TRƯỞNG DOANH THU TRONG KỲ</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable2" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                       <tr>
                            <td> <b style="color: red;">A.1 Doanh thu thuốc tổng toàn công ty tối thiểu 1,380,000đồng.</b></td>
                            <td>Đạt từ 100%</td>
                            <td style="color:red; font-weight:bold;"class="kpi2-score">10% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td> <b style="color: red;">A.2 Doanh thu nhóm không phải thuốc tối thiểu 360 triệu đồng.</b></td>
                            <td>Đạt từ 100%</td>
                            <td style="color:red; font-weight:bold;"class="kpi2-score">10%</td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                       
                           <td> B.1 Tỉ lệ tổng doanh thu khách hàng do  tham gia lập đơn kỳ này so với ký trước  </td>
                             <td>Đạt dưới 9%</td>
                            <td class="kpi2-score"> 10% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                   <tr>
                           <td> C.2 Tỉ lệ tổng doanh thu khách hàng do mình lập đơn kỳ này so với ký trước  </td>
                             <td>Đạt trên 10%</td>
                            <td class="kpi2-score"> 20% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
           
				   </tbody>
                </table>
            </div>
            <!-- Editor BẢNG 2 -->
            <div class="kpi2-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ.</label>
                <div id="kpi2NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 2 -->

        <!-- BẢNG 3 TĨNH -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-green-300 shadow-md">
            <h2 class="text-2xl font-bold text-green-700 mb-6">KPI PHÁT TRIỂN KHÁCH HÀNG MỚI THÀNH CÔNG.</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable3" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
						<tr>
                            <td>A.1 Tổng khách hàng mới chốt hợp tác trong kỳ tháng</td>
                            <td> Đạt tối thiểu từ 1  KH </td>
                            <td class="kpi2-score"> 10% </td>
                         <td><input class="kpi3-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>

                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>					
						<tr>
                            <td>A.2 Tổng khách hàng mới chốt hợp tác trong kỳ </td>
                            <td> Đạt tối thiểu từ 3 KH </td>
                            <td style="color:red;font-weight:bold;"class="kpi2-score"> 20% </td>
                            <td><input class="kpi3-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>

                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
						
                    </tbody>
                </table>
            </div>
            <!-- Editor BẢNG 3 -->
            <div class="kpi3-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi3NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 3 -->
        
        <!-- BẢNG 4 TĨNH -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-blue-300 shadow-md">
            <h2 class="text-2xl font-bold text-blue-700 mb-6">KPI CHỈ ĐIỀU PHỐI KHO  HÀNG- ĐÓNG HÀNG- THƯỞNG VƯỢT TRỘI TRONG BÁN HÀNG</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable4" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                    						
						 <tr>
                            <td><b style="color:green;"> A.1 Hoàn thành đóng góp hàng trong tháng</b></td>
                            <td>Hoàn thành đóng góp đúng thủ tục- quy trình trên 15 đơn hàng/ tháng</td>
                            <td class="kpi4-score">10%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr
						<tr>
                            <td><b style="color:green;"> A.2 Hoàn thành đóng hàng - điều phối giao thành công</b></td>
                            <td>Hoàn thành đóng - giao hàng đúng thủ tục - quy trình trên > 35 đơn/tháng </td>
                            <td style="color:red;font-weight:bold; "class="kpi4-score"> 25%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
							<tr>
		                            <td><b style="color:green;"> A.3 Hoàn thành điều phối và khai báo thu tục liên quan nhiệm vụ quản lý kho trong kỷ</b></td>	
		                            <td>Báo cáo ứng dụng rỏ ràng- dữ liệu khai báo đúng- lưu trữ  </td>			
		                            <td style="color:red;font-weight:bold; "class="kpi4-score"> 20%</td>			
		                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>			
		                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>				
		                        </tr>				
									
							         


								</tbody>
          

		  </table>
            </div>
            <div class="kpi4-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi4NoteEditor" class="quill-editor"></div>
            </div>
			<!-- Quy định/nhận xét cuối bảng tĩnh KPI 3 -->

        </div>
		<div class="mt-4 p-4 border border-dashed border-green-500 bg-green-50 rounded-xl shadow-sm">
  <div class="font-semibold mb-2 text-green-700">QUY ĐỊNH THƯỞNG KPI - TÍNH THƯỞNG HOA HỒNG </div>
  <div class="text-gray-700 leading-relaxed">
  <p><b>ĐIỂM KPI TĂNG SẼ TĂNG THU NHẬP TÍNH ĐIỂM KPI - KPI CÓ THỂ HƠN 100% ĐIỂM CHUẨN</b></p><br>
  
    <p><b>1.</b> Thành công 1 Nhà thuốc cho thuốc có tổng giá trị đặt hàng tối thiểu <b>2,6 triệu đồng</b> - thưởng <b>200,000 đồng</b>.</p>
<p><b>2.</b> Thành công 1 Nhà thuốc cho nhóm không thuốc có tổng giá trị đặt hàng từ <b>2,6 triệu đồng</b> - thưởng <b>400,000 đồng</b>.</p>
<p><b>3.</b> Thành công 1 NPP cho nhóm không thuốc có tổng giá trị đặt hàng từ <b> 8 triệu đồng/đơn</b> - thưởng <b>1 triệu đồng</b>.</p>
<p><b>4.</b> Mở  chuỗi Nhà Thuốc mới có lên đơn tối thiểu <b> 5 triệu đồng</b> thưởng <b>800,000 đồng</b>.</p>
<p><b>5.</b> Mở thành công NT trong phòng khám - có đặt hàng có giá trị tối thiểu <b> 5 triệu đồng</b> - thưởng <b>800,000 đồng</b>.</p>

<u>
  <li>a. Cho phép cộng dồn 2 đơn hàng trong thời gian tối đa <b>20 ngày</b> để có tổng giá trị đơn đạt mức thưởng trên và trả tại thời điểm đơn cuối.</li>
  <li>b. Công ty tính thưởng trên báo cáo cuối kỳ của nhân viên đúng theo quy định và có xác nhận từ bộ phận kế toán - cấp quản lý kinh doanh.</li>
  <li>c. Đối với 1 Nhà thuốc có cùng tư cách pháp nhân khi mở chi nhanh mới thì chi nhánh mới không được tính là mở 1 nhà thuốc mới vì đă dược tính vào doanh thu đặt hàng chung rồi</li>
  <li>d. GHI CHÚ: DOANH THU TÍNH TỈ LỆ TĂNG TRƯỞNG Ở MỤC KPI : LÀ DOANH THU GỘP ( GỒM CẢ CÔNG NỢ) </li>
  
  
</u>

<p><b>HOA HỒNG  ĐƯỢC TÍNH CHO KHÁCH HÀNG DO NHÂN VIÊN KHAI THÁC TRỰC TIẾP VÀ TÍNH LŨY KÊ DOANH THU TẠI THỜI ĐIỂM TRONG KỲ THÁNG</b></p><br>

<p><b>a. Doanh Thu nhóm không phải thuốc:</b><br>
- Doanh thu theo đơn hàng từ <b>2.5triệu đồng</b> - hoa hồng <b>2%</b><br>
- Doanh thu theo đơn hàng từ <b>16 triệu đồng</b> - hoa hồng <b>3%</b><br>
- Doanh thu theo đơn hàng từ <b>30 triệu đồng</b> - hoa hồng <b>5%</b>
- Doanh thu theo đơn hàng từ <b>60 triệu đồng</b> - hoa hồng <b>6.5</b>
</p>

<p><b>b. Doanh thu nhóm thuốc:</b><br>
- Doanh thu theo đơn hàng từ <b>2 triệu đồng</b> - hoa hồng <b>1.5%</b><br>
- Doanh thu theo đơn hàng từ <b>30 triệu đồng</b> - hoa hồng <b>2%</b><br>
- Doanh thu theo đơn hàng từ <b>60 triệu đồng</b> - hoa hồng <b>3.5%</b>
</p>


<p><u>Ghi chú:</u> doanh thu tính trên người lập đơn trên ERP và báo cáo cuối tháng để làm căn cứ tính.</p><br>


 <p><b>1.</b> Lỗi nhắc nhở sai sót khai báo giao dịch khách hàng không đúng quá 3 lần/tháng <b> Trừ 8% điểm KPI</b>.</p>
	   <P><b>2.</b> Không báo cáo nhanh cuối tuần theo quy định mỗi báo cáo cuối tuần không viết- nộp  <b> Trừ 8% điêm KPI</b></p>
<p><b>3.</b> Lỗi báo cáo Cuối Tháng theo quy định trễ hay bị buột phải làm lại do sai sót nhiều <b> Trừ 6 điểm KPI</b>.</p>
<p><b>4.</b> Lỗi sai sót đơn hàng- khai báo đơn hàng quá 3 lần/ tháng <b> Trứ 6 điểm KPI </b>.</p>
<p><b>5.</b> Lỗi không tuân thủ quy định lập kế hoạch định kỳ 4 tuần có 4 bảng kế hoạch  <b> Trừ 8 điểm KPI </b>.</p>
<p><b>6.</b> Lỗi sai khác không đúng quy định công ty đề ra hay ban hành trước đó <b> Trứ điểm 8 điểm KPI/1 lần nhắc</b>.</p>

	
	
  </div>
</div>

        <!-- END BẢNG 4 -->

        <!-- Tổng điểm KPI -->
        <div class="container mx-auto bg-white mb-12 p-6 rounded-lg shadow flex justify-end">
            <div class="text-right">
                <span class="font-semibold text-lg">TỔNG ĐIỂM KPI (cộng tất cả các ô Đánh giá điểm): </span>
                <span class="font-bold text-indigo-600 text-2xl" id="total-evaluation-score">0</span>
            </div>
        </div>

        <div class="flex flex-wrap gap-4 justify-center md:justify-start">
            <button id="saveKpiBtn" class="action-button">Lưu lại</button>
            <button id="exportPdfBtn" class="action-button secondary-button">Xuất file PDF</button>
            <button id="backToListBtn" class="action-button secondary-button">Quay lại Danh sách</button>
			<button id="exportHtmlBtn" class="action-button secondary-button">Xuất file gởi điểm KPI </button>

        </div>
    </div>

    <!-- MODAL DANH SÁCH KPI -->
    <div id="kpiListModal" class="modal">
        <div class="modal-content">
            <span class="float-right text-xl cursor-pointer" id="closeModalBtn">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">KPI ĐIỀU PHỐI KHO- TRỢ Ý KINH DOANH </h2>
            <button id="addNewKpiFromModalBtn" class="action-button mb-6 w-full">Thêm mới Bảng KPI</button>
           <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" target="_blank" class="action-button secondary-button mb-4 w-full text-center block">ERP HOME</a>
            <div id="savedKpiList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyCC2KUiYoGrEWl3GUCk2xUoUU_TQTX-0rw",
  authDomain: "kpi-7d405.firebaseapp.com",
  databaseURL: "https://kpi-7d405-default-rtdb.firebaseio.com",
  projectId: "kpi-7d405",
  storageBucket: "kpi-7d405.appspot.com",
  messagingSenderId: "408635637678",
  appId: "1:408635637678:web:435407046d80ddc42cd23f",
  measurementId: "G-Y9KH6RT5V0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const mainKpiForm = document.getElementById('mainKpiForm');
const kpiTableBody = document.getElementById('kpiTableBody');
const addRowBtn = document.getElementById('addRowBtn');
const saveKpiBtn = document.getElementById('saveKpiBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const backToListBtn = document.getElementById('backToListBtn');
const kpiListModal = document.getElementById('kpiListModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const savedKpiListDiv = document.getElementById('savedKpiList');
const addNewKpiFromModalBtn = document.getElementById('addNewKpiFromModalBtn');
let currentKpiId = null;

// --- QuillJS Editor toolbar config ---
const quillToolbar = [
  ['bold', 'italic', 'underline', 'strike'],
  [{ 'font': [] }],
  [{ 'size': ['small', false, 'large', 'huge'] }],
  [{ 'align': [] }],
  [{ 'color': [] }, { 'background': [] }],
  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
  ['clean']
];

let kpi2NoteEditor, kpi3NoteEditor, kpi4NoteEditor;

// Khởi tạo editor sau khi DOM loaded
function initEditors() {
    kpi2NoteEditor = new Quill('#kpi2NoteEditor', {
      modules: { toolbar: quillToolbar },
      theme: 'snow'
    });
    kpi3NoteEditor = new Quill('#kpi3NoteEditor', {
      modules: { toolbar: quillToolbar },
      theme: 'snow'
    });
    kpi4NoteEditor = new Quill('#kpi4NoteEditor', {
      modules: { toolbar: quillToolbar },
      theme: 'snow'
    });
}
function resetEditors() {
    kpi2NoteEditor.root.innerHTML = '';
    kpi3NoteEditor.root.innerHTML = '';
    kpi4NoteEditor.root.innerHTML = '';
}

function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9) + Date.now();
}
function showForm() { mainKpiForm.style.display = 'block'; }
function hideForm() { mainKpiForm.style.display = 'none'; }
function openModal() { displaySavedKpis(); kpiListModal.style.display = 'block'; }
function closeModal() { kpiListModal.style.display = 'none'; }

function addKpiRow(data = {}) {
    const row = kpiTableBody.insertRow();
    row.innerHTML = `
        <td><textarea class="kpiIndicator w-full p-2 border rounded-md" placeholder="Mô tả chỉ số">${data.kpiIndicator||''}</textarea></td>
        <td><input type="text" class="achievedIndicator w-full p-2 border rounded-md" value="${data.achievedIndicator||''}"></td>
        <td><input type="number" class="kpiScore w-full p-2 border rounded-md" value="${data.kpiScore||''}"></td>
        <td><input type="number" class="scoreEvaluation w-full p-2 border rounded-md" value="${data.scoreEvaluation||''}"></td>
        <td><textarea class="reportNotes w-full p-2 border rounded-md">${data.reportNotes||''}</textarea></td>
        <td class="text-center"><button class="deleteRowBtn danger-button text-xs px-2 py-1">Xóa</button></td>
    `;
    row.querySelector('.deleteRowBtn').onclick = ()=>{ row.remove(); calcTotalEvaluationScore(); };
    row.querySelector('.scoreEvaluation').addEventListener('input', calcTotalEvaluationScore);
}

addRowBtn.onclick = ()=>addKpiRow();

function saveKpiData() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đầy đủ Tên người lập, Bộ phận và Ngày lập.');
        return false;
    }
    const kpiRowsData = [];
    const rows = kpiTableBody.querySelectorAll('tr');
    rows.forEach(row=>{
        const kpiIndicator = row.querySelector('.kpiIndicator');
        if (kpiIndicator && kpiIndicator.value.trim()) {
            kpiRowsData.push({
                kpiIndicator: kpiIndicator.value.trim(),
                achievedIndicator: row.querySelector('.achievedIndicator').value.trim(),
                kpiScore: row.querySelector('.kpiScore').value,
                scoreEvaluation: row.querySelector('.scoreEvaluation').value,
                reportNotes: row.querySelector('.reportNotes').value.trim(),
            });
        }
    });

    // Lưu nội dung Quill editor
    const kpi2Note = kpi2NoteEditor.root.innerHTML;
    const kpi3Note = kpi3NoteEditor.root.innerHTML;
    const kpi4Note = kpi4NoteEditor.root.innerHTML;

    // Lưu giá trị đánh giá từ các bảng tĩnh
    const kpi2Evaluations = Array.from(document.querySelectorAll('#kpiTable2 .kpi2-evaluation')).map(el => el.value);
    const kpi3Evaluations = Array.from(document.querySelectorAll('#kpiTable3 .kpi3-evaluation')).map(el => el.value);
    const kpi4Evaluations = Array.from(document.querySelectorAll('#kpiTable4 .kpi4-evaluation')).map(el => el.value);

    let kpiData = {
        creatorName, department, creationDate, kpiRows: kpiRowsData,
        kpi2Note, kpi3Note, kpi4Note,
        kpi2Evaluations, kpi3Evaluations, kpi4Evaluations, // Thêm dữ liệu đánh giá từ các bảng tĩnh
        year: new Date().getFullYear(), id: currentKpiId || generateId()
    };
    db.ref('kpiBoards_v2/'+kpiData.id).set(kpiData, err=>{
        if (err) alert('Lỗi khi lưu lên server: '+err.message);
        else {
            alert('Đã lưu bảng KPI!');
            currentKpiId = kpiData.id;
            displaySavedKpis();
        }
    });
    return true;
}
saveKpiBtn.onclick = ()=>saveKpiData();

function displaySavedKpis() {
    savedKpiListDiv.innerHTML = '<p class="text-gray-500">Đang tải dữ liệu...</p>';
    db.ref('kpiBoards_v2').once('value', snapshot=>{
        const kpisObj = snapshot.val()||{};
        const kpis = Object.values(kpisObj);
        savedKpiListDiv.innerHTML = '';
        if (kpis.length === 0) {
            savedKpiListDiv.innerHTML = '<p class="text-gray-500">Chưa có bảng KPI nào được lưu.</p>'; return;
        }
        kpis.sort((a,b)=>b.creationDate.localeCompare(a.creationDate));
        kpis.forEach(kpi=>{
            const div = document.createElement('div');
            div.className = 'kpi-list-item p-4 border rounded-md shadow-sm flex justify-between items-center bg-gray-50';
            div.innerHTML = `
                <div class="flex-grow cursor-pointer">
                    <p class="font-semibold text-indigo-600">${kpi.creatorName} (${kpi.year})</p>
                    <p class="text-sm text-gray-600">${kpi.department} - ${kpi.creationDate}</p>
                </div>
                <button class="deleteSavedKpiBtn danger-button text-xs px-2 py-1" data-id="${kpi.id}">Xóa</button>
            `;
            div.querySelector('.flex-grow').onclick = ()=>loadKpiToForm(kpi.id);
            div.querySelector('.deleteSavedKpiBtn').onclick = e=>{
                e.stopPropagation(); 
                // --- Xác nhận password khi xóa ---
                const password = prompt('Vui lòng nhập mật khẩu để xác nhận xóa:');
                if (password !== 'minhtriet1973') {
                    alert('Sai mật khẩu! Không được xóa.');
                    return;
                }
                deleteKpi(kpi.id);
            };
            savedKpiListDiv.appendChild(div);
        });
    });
}

function loadKpiToForm(kpiId) {
    db.ref('kpiBoards_v2/'+kpiId).once('value', snap=>{
        const kpi = snap.val();
        if (kpi) {
            currentKpiId = kpiId;
            document.getElementById('creatorName').value = kpi.creatorName;
            document.getElementById('department').value = kpi.department;
            document.getElementById('creationDate').value = kpi.creationDate;
            kpiTableBody.innerHTML = '';
            (kpi.kpiRows||[]).forEach(r=>addKpiRow(r));
            if ((kpi.kpiRows||[]).length===0) addKpiRow();
            
            // Khôi phục giá trị đánh giá từ các bảng tĩnh
            if (kpi.kpi2Evaluations) {
                document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach((el, index) => {
                    if (kpi.kpi2Evaluations[index]) el.value = kpi.kpi2Evaluations[index];
                });
            }
            
            if (kpi.kpi3Evaluations) {
                document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach((el, index) => {
                    if (kpi.kpi3Evaluations[index]) el.value = kpi.kpi3Evaluations[index];
                });
            }
            
            if (kpi.kpi4Evaluations) {
                document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach((el, index) => {
                    if (kpi.kpi4Evaluations[index]) el.value = kpi.kpi4Evaluations[index];
                });
            }
            
            // Đọc nội dung note editor
            kpi2NoteEditor.root.innerHTML = kpi.kpi2Note || '';
            kpi3NoteEditor.root.innerHTML = kpi.kpi3Note || '';
            kpi4NoteEditor.root.innerHTML = kpi.kpi4Note || '';
            showForm(); closeModal();
            calcTotalEvaluationScore();
        }
    });
}
function resetMainFormAndShow() {
    document.getElementById('creatorName').value = '';
    document.getElementById('department').value = '';
    document.getElementById('creationDate').valueAsDate = new Date();
    kpiTableBody.innerHTML = ''; addKpiRow();
    resetEditors();
    currentKpiId = null; showForm(); closeModal();
    calcTotalEvaluationScore();
}

function deleteKpi(kpiIdToDelete) {
    db.ref('kpiBoards_v2/'+kpiIdToDelete).remove().then(()=>{
        displaySavedKpis();
        if (currentKpiId===kpiIdToDelete) {
            currentKpiId = null; resetMainFormAndShow(); hideForm(); openModal();
        }
    });
}

addNewKpiFromModalBtn.onclick = resetMainFormAndShow;
closeModalBtn.onclick = closeModal;
backToListBtn.onclick = ()=>{ hideForm(); openModal(); };

document.getElementById('exportPdfBtn').onclick = function () {
    const creatorName = document.getElementById('creatorName').value.trim().replace(/[^a-zA-Z0-9]/g,'');
    const department = document.getElementById('department').value.trim().replace(/[^a-zA-Z0-9]/g,'');
    const creationDate = document.getElementById('creationDate').value;
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đủ Tên người lập, Bộ phận, Ngày lập trước khi xuất PDF!');
        return;
    }
    // Ẩn các nút xuất PDF, xuất HTML, v.v. cho sạch
    document.getElementById('exportPdfBtn').style.display = 'none';
    document.getElementById('exportHtmlBtn').style.display = 'none';
    document.getElementById('saveKpiBtn').style.display = 'none';
    document.getElementById('backToListBtn').style.display = 'none';

    // Lấy vùng xuất (cả giao diện form chính)
    const element = document.getElementById('mainKpiForm');
    const opt = {
        margin:       [0.3, 0.3, 0.3, 0.3], // lề các bên
        filename:     `${creatorName}-${department}-${creationDate}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' },
        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };
    html2pdf().set(opt).from(element).save().then(() => {
        // Hiện lại nút sau khi xong
        document.getElementById('exportPdfBtn').style.display = '';
        document.getElementById('exportHtmlBtn').style.display = '';
        document.getElementById('saveKpiBtn').style.display = '';
        document.getElementById('backToListBtn').style.display = '';
    });
};



// --- TÍNH TỔNG "Đánh giá điểm" cả 4 bảng ---
function calcTotalEvaluationScore() {
    let sum = 0;
    // Bảng 1 (động)
    document.querySelectorAll('#kpiTableBody .scoreEvaluation').forEach(cell => {
        let val = parseFloat(cell.value);
        if (!isNaN(val)) sum += val;
    });
    // Bảng 2 (tĩnh)
    document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach(input => {
        let v = parseFloat(input.value);
        if (!isNaN(v)) sum += v;
    });
    // Bảng 3 (tĩnh)
    document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach(input => {
        let v = parseFloat(input.value);
        if (!isNaN(v)) sum += v;
    });
    // Bảng 4 (tĩnh) - THÊM MỚI!
    document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach(input => {
        let v = parseFloat(input.value);
        if (!isNaN(v)) sum += v;
    });
    document.getElementById('total-evaluation-score').textContent = sum;
}

// Sự kiện auto update tổng điểm khi nhập
function addEvaluationInputEvents() {
    // Bảng 1
    kpiTableBody.addEventListener('input', e => {
        if (e.target.classList.contains('scoreEvaluation')) calcTotalEvaluationScore();
    });
    // Bảng 2
    document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach(input => {
        input.addEventListener('input', calcTotalEvaluationScore);
    });
    // Bảng 3
    document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach(input => {
        input.addEventListener('input', calcTotalEvaluationScore);
    });
    // Bảng 4
    document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach(input => {
        input.addEventListener('input', calcTotalEvaluationScore);
    });
}

// ... Khi load trang và reset/hiện form nhớ gọi addEvaluationInputEvents() và calcTotalEvaluationScore() ...
document.addEventListener('DOMContentLoaded', ()=>{
    initEditors();
    addEvaluationInputEvents();
    calcTotalEvaluationScore();
    openModal();
    document.getElementById('creationDate').valueAsDate = new Date();
});
// ========== XUẤT FILE HTML TĨNH KHÔNG CHO CHỈNH SỬA ==========
document.getElementById('exportHtmlBtn').onclick = function() {
    // Lấy thông tin để đặt tên file
    const creatorName = document.getElementById('creatorName').value.trim().replace(/[^a-zA-Z0-9]/g,'');
    const department = document.getElementById('department').value.trim().replace(/[^a-zA-Z0-9]/g,'');
    const creationDate = document.getElementById('creationDate').value;
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đủ Tên người lập, Bộ phận, Ngày lập trước khi xuất HTML!');
        return;
    }
    // Lấy toàn bộ dữ liệu từ form hiện tại
    const kpiRows = Array.from(document.querySelectorAll('#kpiTableBody tr')).map(row => ({
        kpiIndicator: row.querySelector('.kpiIndicator').value,
        achievedIndicator: row.querySelector('.achievedIndicator').value,
        kpiScore: row.querySelector('.kpiScore').value,
        scoreEvaluation: row.querySelector('.scoreEvaluation').value,
        reportNotes: row.querySelector('.reportNotes').value,
    }));
    // Lấy dữ liệu bảng 2, 3, 4 tĩnh
    const kpi2 = Array.from(document.querySelectorAll('#kpiTable2 tbody tr')).map(row => ({
        cells: Array.from(row.children).map(cell => {
            if(cell.querySelector('input')) return cell.querySelector('input').value;
            if(cell.querySelector('textarea')) return cell.querySelector('textarea').value;
            return cell.innerHTML;
        })
    }));
    const kpi3 = Array.from(document.querySelectorAll('#kpiTable3 tbody tr')).map(row => ({
        cells: Array.from(row.children).map(cell => {
            if(cell.querySelector('input')) return cell.querySelector('input').value;
            if(cell.querySelector('textarea')) return cell.querySelector('textarea').value;
            return cell.innerHTML;
        })
    }));
    const kpi4 = Array.from(document.querySelectorAll('#kpiTable4 tbody tr')).map(row => ({
        cells: Array.from(row.children).map(cell => {
            if(cell.querySelector('input')) return cell.querySelector('input').value;
            if(cell.querySelector('textarea')) return cell.querySelector('textarea').value;
            return cell.innerHTML;
        })
    }));
    // Ghi chú cuối kỳ
    const kpi2Note = document.querySelector('#kpi2NoteEditor .ql-editor').innerHTML;
    const kpi3Note = document.querySelector('#kpi3NoteEditor .ql-editor').innerHTML;
    const kpi4Note = document.querySelector('#kpi4NoteEditor .ql-editor').innerHTML;
    // Tổng điểm
    const totalScore = document.getElementById('total-evaluation-score').textContent;

    // HTML mới: KHÔNG chứa input, textarea, button, modal
    const style = `<style>
        body { font-family: 'Inter',sans-serif; background: #f3f4f6; }
        .container { background: #fff; border-radius: 14px; box-shadow: 0 2px 8px #ccc5; margin: 40px auto; max-width: 1100px; padding: 24px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; vertical-align: top; }
        th { background: #4f46e5; color: #fff; }
        h1, h2 { margin-top: 0; }
        .framed-info { border: 2px solid #6366f1; border-radius: 14px; background: #f5f3ff; box-shadow: 0 1px 8px #d1d5db33; padding: 16px; }
        .static-value { display: block; min-height: 28px; background: #f1f5f9; padding: 6px 10px; border-radius: 5px; }
        .quill-view { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 10px 18px; min-height: 50px; }
    </style>`;
    const kpiRowsHtml = kpiRows.map(r=>`
        <tr>
            <td><span class="static-value">${r.kpiIndicator}</span></td>
            <td><span class="static-value">${r.achievedIndicator}</span></td>
            <td><span class="static-value">${r.kpiScore}</span></td>
            <td><span class="static-value">${r.scoreEvaluation}</span></td>
            <td><span class="static-value">${r.reportNotes}</span></td>
            <td></td>
        </tr>
    `).join('');
    const genTableHtml = arr=>arr.map(r=>`<tr>${r.cells.map(c=>`<td><span class="static-value">${c}</span></td>`).join('')}</tr>`).join('');
    // Giao diện mới
    const html = `
    <!DOCTYPE html>
    <html lang="vi"><head>
        <meta charset="utf-8">
        <title>KPI Report - ${creatorName} ${department} ${creationDate}</title>
        ${style}
    </head><body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-8" style="color:#4f46e5">BẢNG KPI KINH DOANH CHO CẤP PHỤ TRÁCH KINH VỰC</h1>
        <div class="framed-info mb-8" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div>
                <label><b>Tên người lập:</b></label>
                <span class="static-value">${document.getElementById('creatorName').value}</span>
            </div>
            <div>
                <label><b>Bộ phận:</b></label>
                <span class="static-value">${document.getElementById('department').value}</span>
            </div>
            <div>
                <label><b>Ngày lập:</b></label>
                <span class="static-value">${document.getElementById('creationDate').value}</span>
            </div>
        </div>
        <h2 style="color:#1e293b">KPI HOÀN THÀNH NHIỆM VỤ THEO ĐỊNH HƯỚNG THÁNG-TUẦN</h2>
        <div style="overflow-x:auto">
        <table>
            <thead>
                <tr>
                    <th>Chỉ số KPI</th><th>Đạt chỉ số</th><th>Điểm KPI %</th><th>Đánh giá điểm</th><th>Báo cáo</th><th></th>
                </tr>
            </thead>
            <tbody>${kpiRowsHtml}</tbody>
        </table>
        </div>
        <h2 style="color:#4f46e5">KPI DOANH THU</h2>
        <table>${document.querySelector('#kpiTable2 thead').outerHTML}<tbody>${genTableHtml(kpi2)}</tbody></table>
        <div><b>Phân tích báo cáo cuối kỳ:</b><div class="quill-view">${kpi2Note}</div></div>

        <h2 style="color:#15803d">KPI PHÁT TRIỂN KHÁCH HÀNG MỚI THÀNH CÔNG</h2>
        <table>${document.querySelector('#kpiTable3 thead').outerHTML}<tbody>${genTableHtml(kpi3)}</tbody></table>
        <div><b>Phân tích báo cáo cuối kỳ:</b><div class="quill-view">${kpi3Note}</div></div>

        <h2 style="color:#2563eb">KPI CHỈ SỐ QUẢN LÝ - XÚC TIẾN ĐƠN HÀNG THÀNH CÔNG</h2>
        <table>${document.querySelector('#kpiTable4 thead').outerHTML}<tbody>${genTableHtml(kpi4)}</tbody></table>
        <div><b>Phân tích báo cáo cuối kỳ:</b><div class="quill-view">${kpi4Note}</div></div>

        <div class="mt-8 mb-2" style="text-align:right">
            <span style="font-weight:600">TỔNG ĐIỂM KPI: </span>
            <span style="font-weight:bold;color:#4f46e5;font-size:2rem">${totalScore}</span>
        </div>
        <hr style="margin:24px 0;">
        <div style="background:#f0fff0;border:1.5px dashed #22c55e;padding:14px 20px;border-radius:15px;">
            <div class="font-semibold mb-2 text-green-700">QUY ĐỊNH THƯỞNG KPI - TÍNH THƯỞNG HOA HỒNG </div>
            <div class="text-gray-700 leading-relaxed" style="font-size:1rem">
                ${document.querySelector('.border-green-500.bg-green-50').innerHTML}
            </div>
        </div>
        <div style="margin-top:24px;color:#999;font-size:14px;text-align:right">Xuất file lúc: ${new Date().toLocaleString()}</div>
    </div>
    </body></html>
    `;

    // Tạo và tải file
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    const fileName = `${creatorName}-${department}-${creationDate}.html`;
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
};

</script>
</body>
</html>
